---
title: "npi_firstpass"
author: "aj_mitchell"
date: "April 3, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyselect)
library(ggplot2)
library(broom)
library(dplyr)
library(corrplot)
library(kableExtra)
library(knitr)
library(Hmisc)
library(infer)
library(plotly) 
library(skimr)
library(stringr)
library(reshape2)
library(som)
library(readxl)
library(manipulate)
library(lavaan)
library(semPlot)
library(readxl)
library(formattable)
library(DT)
#library(wesanderson)
#library(ggthemes)
```

**This document is for explaining the pilot NPI behavior analysis.**

###Intro###

A total of 21 subjects were included in the analysis. 2 of these subjects are yet to be identified protein restricted (PR) or CNT. This is partially because they are on neither list which defining year 1 vs year 2 animals (although it is clear by the animals id that these are year 2 subjects). This information will be easy to incorporate and update. 

29 individual behaviors were included in the analysis and subsequently divided up into 4 composite groups to investigate the effects of PR. These composite groups were made based on aggregates of *anxious behaviors*, *pro-social behavior (social affiliation)*, *non-affiliative social behaviors*, and *object oriented behaviors*.  These scores are outlined in later tables below.  

The table below provides correlational values about the individual behaviors.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
    
NPI_znorm_v1 <- read_excel("norm_correct_avgdsubj_NPI_v1.xlsx")
NPI_znorm_v1$diet_group <- as.factor(NPI_znorm_v1$diet_group)

#skim(selected_NPIgroup_znorm_v1)

selected_NPI_znorm_v1 <- NPI_znorm_v1 %>%
  select(- Result_Containers, - Statistics, - Observations, - Intervals, - Subjects, - Animal_lD, - Hanging_Toy_at_perch_N0Y1, - Perch_at_dividerN0Y1, - Duration, - Introduction, - diet_group)

skim(selected_NPI_znorm_v1)

selected_NPIgroup_znorm_v1 <- NPI_znorm_v1 %>%
  select(- Result_Containers, - Statistics, - Observations, - Intervals, - Subjects, - Hanging_Toy_at_perch_N0Y1, - Perch_at_dividerN0Y1, - Duration, - Introduction)


```

The first table outlines the overall effects of protein restriction whereas the latter graphs detail specific differences of either 33% or 50% PR. I did not look at individual behavioral differences (comparing individual behaviors across diet groups). **Only pro-social behavior surrounding the 50 PR showed significant differences based on diet group.** This is visualized later in the document. 




```{r, include=F}
#View(selected_NPIgroup_znorm_v1)

#ListVariableNames <- function(DATA) {
 #   cat('"', noquote(paste(names(DATA), collapse='","')), '"\n', sep='')
#}


#anx_behavs <- c("ZStereotypy",
#               "ZScratch",
 ##              "ZYawn",
   #            "ZCrook_Tail",
    #           "ZPlay",
     #          "ZPlay_Face",
      #         "ZNo_Response",
       #        "ZLipsmack",
        #       "ZInspect",
         #      "ZMouth_peer",
          #     "ZContact_peer",
           #    "ZContact_peer_count",
            #  "ZOpen_Mouth_Threat",
             #  "ZAggress",
              # "ZFear_Grimace",
               #"ZBite",
               #"ZSteal_Resource_Attempt",
               #"ZSteal_Resource_Attempt_count",
               #"ZResource_Takeover",
               #"ZDisplace",
               #"ZAvoid",
               #"ZFollow",
               #"ZGroom",
               #"ZApproach_peer",
               #"ZLeave_peer",
               #"ZNo_Response_to_Object",
               #"ZMouth_Object",
               #"ZTouch_Object",
               #"ZManipulate_Object",
               #"ZInspect_Object")
```               

**Prosocial** = "Play",
               "Play Face",
               "Contact peer",
               "Follow",
               "Groom",
               "Approach peer",
               "Lipsmack",
               "Inspect",
               "Mouth peer")

**Nonsocial** =    "Open Mouth Threat",
               "Aggress",
               "Bite",
               "Resource Takeover",
               "Displace",
               "Avoid",
               "Crooked Tail"

**Object_Oriented** = "Mouth Object",
               "Touch Object",
               "Manipulate Object",
               "Inspect Object",
               "Steal Resource Attempt"

**Anxious** =  "Stereotypy",
               "Scratch",
               "Yawn",
               "Avoid",
               "Fear Grimmace"
               
**Omitted or used *twice** = "No Response to Object",
              "Contact Peer Count",
              "No Response",
              *"Steal Resource Attempt count"

Some of the more ambigious groupings like resource takeover or steal resource attempt were used in both object oriented and non-social behavior
               
```{r, echo=F, warning=F, message=F}
#Behavior_table <- rbind(Anxious, Prosocial, Nonsocial, Object_Oriented)

#ListVariableNames(selected_NPIgroup_znorm_v1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
cor_selected_NPI <- cor(selected_NPI_znorm_v1)
melted_cor_selected_NPI <- melt(cor_selected_NPI) %>%
  filter(value <= .99)
```


```{r, echo=F, message=F, warning=F}
datatable(formattable(melted_cor_selected_NPI))
```

Correllation Matrix Visualization 

```{r, echo=F, message=F, warning=F}

corrmat_NPI <- ggplot(melted_cor_selected_NPI, aes(x=Var2, y=Var1, fill=value)) +
  geom_tile() +
  scale_fill_gradient(low = "dark blue", high = "orange") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 1,
                                   size = 9,
                                   hjust = 1))

corrmat_NPI+labs(title="NPI Behavior Correlation Matrix", x="Diet")  +
  scale_color_manual(values = wes_palette(n=2, "GrandBudapest1")) +
  theme(plot.background = element_rect(fill = "light gray"),
        panel.background = element_rect(fill = "dark gray"),
        legend.background = element_rect(fill = "dark gray"))

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

############
selected_NPIgroup_znorm_v1$social_affiliative <- selected_NPIgroup_znorm_v1$ZContact_peer + selected_NPIgroup_znorm_v1$ZPlay + selected_NPIgroup_znorm_v1$ZPlay_Face + selected_NPIgroup_znorm_v1$ZGroom + selected_NPIgroup_znorm_v1$ZMouth_peer + selected_NPIgroup_znorm_v1$ZLipsmack + selected_NPIgroup_znorm_v1$ZApproach_peer 


#v2 are edits to my groups based on what is outlined in the above text. social_affiliative_v2 adds follow and inspect to the original prosocial group 
selected_NPIgroup_znorm_v1$social_affiliative_v2 <- selected_NPIgroup_znorm_v1$ZContact_peer + selected_NPIgroup_znorm_v1$ZPlay + selected_NPIgroup_znorm_v1$ZPlay_Face + selected_NPIgroup_znorm_v1$ZGroom + selected_NPIgroup_znorm_v1$ZMouth_peer + selected_NPIgroup_znorm_v1$ZLipsmack + selected_NPIgroup_znorm_v1$ZApproach_peer + selected_NPIgroup_znorm_v1$ZFollow + selected_NPIgroup_znorm_v1$ZInspect

############

#count not used because object orientation is how long were you attempting to steal the resource, not how much?
selected_NPIgroup_znorm_v1$object_oriented <- selected_NPIgroup_znorm_v1$ZInspect_Object + selected_NPIgroup_znorm_v1$ZMouth_Object + selected_NPIgroup_znorm_v1$ZManipulate_Object + selected_NPIgroup_znorm_v1$ZTouch_Object + selected_NPIgroup_znorm_v1$ZSteal_Resource_Attempt 

##############

selected_NPIgroup_znorm_v1$social_nonaffiliative <- selected_NPIgroup_znorm_v1$ZCrook_Tail + selected_NPIgroup_znorm_v1$ZOpen_Mouth_Threat + selected_NPIgroup_znorm_v1$ZAggress + selected_NPIgroup_znorm_v1$ZBite + selected_NPIgroup_znorm_v1$ZDisplace + selected_NPIgroup_znorm_v1$ZLeave_peer + selected_NPIgroup_znorm_v1$ZAvoid

# v2 nonaffiliative_v2 has resource takeover and resource takeover attempts (count) included. count is used becuase it is a measurement of how persistent an individual was at taking over a resource
selected_NPIgroup_znorm_v1$social_nonaffiliative_v2 <- selected_NPIgroup_znorm_v1$ZCrook_Tail + selected_NPIgroup_znorm_v1$ZOpen_Mouth_Threat + selected_NPIgroup_znorm_v1$ZAggress + selected_NPIgroup_znorm_v1$ZBite + selected_NPIgroup_znorm_v1$ZDisplace + selected_NPIgroup_znorm_v1$ZLeave_peer + selected_NPIgroup_znorm_v1$ZAvoid + selected_NPIgroup_znorm_v1$ZResource_Takeover + selected_NPIgroup_znorm_v1$ZSteal_Resource_Attempt_count


################

selected_NPIgroup_znorm_v1$anxious <- selected_NPIgroup_znorm_v1$ZStereotypy + selected_NPIgroup_znorm_v1$ZScratch + selected_NPIgroup_znorm_v1$ZYawn + selected_NPIgroup_znorm_v1$ZAvoid + selected_NPIgroup_znorm_v1$ZFear_Grimace

View(selected_NPIgroup_znorm_v1)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#740 and 764 reintroduced


######## object oriented

object_oriented_v <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, object_oriented, diet_group) 

#..vR == the undefined diet group subjects (0, n=2) removed 
object_oriented_vR <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, object_oriented, diet_group)


object_oriented_vR_50 <- object_oriented_vR %>%
  filter(Animal_lD <= 35000)

object_oriented_vR_33 <- object_oriented_vR %>%
  filter(Animal_lD >= 35000)

glimpse(object_oriented_vR_50)

####### social affiliative

social_affiliative_v <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, social_affiliative, diet_group)


social_affiliative_vR <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, social_affiliative, diet_group) 

social_affiliative_vR_v2 <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, social_affiliative_v2, diet_group)


social_affiliative_vR_50 <- social_affiliative_vR %>%
  filter(Animal_lD <= 35000)

social_affiliative_vR_33 <- social_affiliative_vR %>%
  filter(Animal_lD >= 35000)

social_affiliative_vR_50_v2 <- social_affiliative_vR_v2 %>%
  filter(Animal_lD <= 35000)

social_affiliative_vR_33_v2 <- social_affiliative_vR_v2 %>%
  filter(Animal_lD >= 35000)

View(social_affiliative_vR_33)

######## social_nonaffiliative 

social_nonaffiliative_v <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, social_nonaffiliative, diet_group)

social_nonaffiliative_vR_v2 <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, social_nonaffiliative_v2, diet_group) 

social_nonaffiliative_vR_50 <- social_nonaffiliative_vR %>%
  filter(Animal_lD <= 35000)

social_nonaffiliative_vR_33 <- social_nonaffiliative_vR %>%
  filter(Animal_lD >= 35000)

#changes below are made to compare and include the altered versions of the composite groups 

social_nonaffiliative_vR_50_v2 <- social_nonaffiliative_vR_v2 %>%
  filter(Animal_lD <= 35000)

social_nonaffiliative_vR_33_v2 <- social_nonaffiliative_vR_v2 %>%
  filter(Animal_lD >= 35000)

#skim(social_nonaffiliative_vR_33)

######## anxious 

anxious_v <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, anxious, diet_group)

anxious_vR <- selected_NPIgroup_znorm_v1 %>%
  select(Animal_lD, anxious, diet_group) 

anxious_vR_50 <- anxious_vR %>%
  filter(Animal_lD <= 35000)

anxious_vR_33 <- anxious_vR %>%
  filter(Animal_lD >= 35000)

skim(anxious_vR_33)

```

##Year 1 vs Year 2 differences##

The table below describes differences based on year one and year two. In summary, only year 1 displayed behavioral differences. Year 1 subjected to a PR diet were less likely to engage in prosocial behavior. 

Year 1 Information:
  - n = 8
  - 4 CTR(1) / 4 PR(2)
  
Year 2 Information:
  - n = 13
  - 7 CTR(1) / 6 PR(2)
  
  
Each group was subject to a Shapiro Wilks test for normality, and the respective t-test was done to calculate the p-value. For groupings whose distribution strongly deviated from the norm, a Wilcoxon/Mann-Whitney test was used. The command is interchangable in R and both pair and unpair commands were tested to ensure values are accurate.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#differences dependent on PR levels 

#shapiro.test(social_nonaffiliative_vR_33_v2$social_nonaffiliative_v2)


##############

#anxious..50_ttest has normal distribution 
anxious_vR_33_ttest <- wilcox.test(anxious_vR_33$anxious~anxious_vR_33$diet_group, paired=FALSE)
anxious_vR_50_ttest <- t.test(anxious_vR_50$anxious~anxious_vR_50$diet_group)

##############

#social_affiliative...50 has normal distribution  
social_affiliative_vR_33_ttest <- wilcox.test(social_affiliative_vR_33$social_affiliative~social_affiliative_vR_33$diet_group, paired=FALSE)

social_affiliative_vR_33_v2_ttest <- wilcox.test(social_affiliative_vR_33_v2$social_affiliative_v2~social_affiliative_vR_33_v2$diet_group, paired=FALSE)

social_affiliative_vR_50_ttest <- t.test(social_affiliative_vR_50$social_affiliative~social_affiliative_vR_50$diet_group, paired=FALSE)

social_affiliative_vR_50_v2_ttest <- t.test(social_affiliative_vR_50_v2$social_affiliative_v2~social_affiliative_vR_50_v2$diet_group, paired=FALSE)

#social_affiliative_vR_33_ttest_unpaired$p.value

##############


#both social_non...33 and social_non..50 have normal distributions
social_nonaffiliative_vR_33_ttest <- t.test(social_nonaffiliative_vR_33$social_nonaffiliative~social_nonaffiliative_vR_33$diet_group, paired=F)

social_nonaffiliative_vR_33_v2_ttest <- t.test(social_nonaffiliative_vR_33_v2$social_nonaffiliative_v2~social_nonaffiliative_vR_33_v2$diet_group, paired=F)

social_nonaffiliative_vR_50_ttest <- t.test(social_nonaffiliative_vR_50$social_nonaffiliative~social_nonaffiliative_vR_50$diet_group, paired=F)

social_nonaffiliative_vR_50_v2_ttest <- t.test(social_nonaffiliative_vR_50_v2$social_nonaffiliative_v2~social_nonaffiliative_vR_50_v2$diet_group, paired=F)

##############

#both object_ori..33 and object_ori..50 have normal distributions
object_oriented_vR_33_ttest <- t.test(object_oriented_vR_33$object_oriented~object_oriented_vR_33$diet_group, paired=F)

object_oriented_vR_50_ttest <- t.test(object_oriented_vR_50$object_oriented~object_oriented_vR_50$diet_group, paired=F)


###########
#table
###########



pvals_PRgroups_on_behaviors <- c(anxious_vR_33_ttest$p.value,
                                 anxious_vR_50_ttest$p.value,
                                 social_affiliative_vR_33_ttest$p.value,
                                 social_affiliative_vR_33_v2_ttest$p.value,
                                 social_affiliative_vR_50_ttest$p.value,
                                 social_affiliative_vR_50_v2_ttest$p.value,
                                 social_nonaffiliative_vR_33_ttest$p.value,
                                 social_nonaffiliative_vR_33_v2_ttest$p.value,
                                 social_nonaffiliative_vR_50_ttest$p.value,
                                 social_nonaffiliative_vR_50_v2_ttest$p.value,
                                 object_oriented_vR_33_ttest$p.value,
                                 object_oriented_vR_50_ttest$p.value)
pvals_PRgroups_titles <- c("Anxious_33per_PR",
                           "Anxious_50per_PR",
                           "Pro-Social_33per_PR",
                           "Pro-Social_33per_PR_v2",
                           "Pro-Social_50per_PR",
                           "Pro-Social_50per_PR_v2",
                           "Non-Affiliative_33per_PR",
                           "Non-Affiliative_33per_PR_v2",
                           "Non-Affiliative_50per_PR",
                           "Non-Affiliative_50per_PR_v2",
                           "Object_Oriented_33per_PR",
                           "Object_Oriented_50per_PR")
#this table defines differences based on 50 percent and 30 percent PR..
PR_group_differences <- data.frame(pvals_PRgroups_titles, pvals_PRgroups_on_behaviors)

datatable(formattable(PR_group_differences))
#prosocial behaviors are significan
```

Below is the boxplot overlayed with scatter plot showing both the avg difference between groups and where each individual falls per group. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(wesanderson)
library(ggthemes)

customviz_affil_vR50 <- ggplot(social_affiliative_vR_50, aes(x=diet_group, y=social_affiliative, color=diet_group)) +
  geom_boxplot() +
  geom_jitter() +
  theme_grey()
  #geom_smooth(method = "lm", se =FALSE)

customviz_affil_vR50+labs(title="Social Affiliative Behaviors (CTR=1, PR=2)", x="Diet",y="Affiliative Behavior")  +
  scale_color_manual(values = wes_palette(n=2, "GrandBudapest1")) +
  theme(plot.background = element_rect(fill = "light gray"),
        panel.background = element_rect(fill = "dark gray"),
        legend.background = element_rect(fill = "dark gray"))

#social_aff_color_test+labs(title="Social Affiliative Behaviors", x="Diet",y="Affiliative Composite Score") +
  #theme_economist()
```

##Extra Visualizations##

Here, only the non_affiliative group is visualized because it is the closest to significant P-value. 

```{r, echo=F, warning=F, message=F}
####nonaffiliative

customviz_nonaffil_vR50 <- ggplot(social_nonaffiliative_vR_50, aes(x=diet_group, y=social_nonaffiliative, color=diet_group)) +
  geom_boxplot() +
  geom_jitter() +
  theme_grey()
  #geom_smooth(method = "lm", se =FALSE)

customviz_nonaffil_vR50+labs(title="Year 1: Social Non-Affiliative Behaviors (CTR=1, PR=2)", x="Diet",y="Non-Affiliative Behavior")  +
  scale_color_manual(values = wes_palette(n=2, "GrandBudapest1")) +
  theme(plot.background = element_rect(fill = "light gray"),
        panel.background = element_rect(fill = "dark gray"),
        legend.background = element_rect(fill = "dark gray"))

customviz_nonaffil_vR50_v2 <- ggplot(social_nonaffiliative_vR_50_v2, aes(x=diet_group, y=social_nonaffiliative_v2, color=diet_group)) +
  geom_boxplot() +
  geom_jitter() +
  theme_grey()
  #geom_smooth(method = "lm", se =FALSE)

customviz_nonaffil_vR50_v2+labs(title="Year 1: Social Non-Affiliative (v2) Behaviors (CTR=1, PR=2)", x="Diet",y="Non-Affiliative Behavior (v2)")  +
  scale_color_manual(values = wes_palette(n=2, "GrandBudapest1")) +
  theme(plot.background = element_rect(fill = "light gray"),
        panel.background = element_rect(fill = "dark gray"),
        legend.background = element_rect(fill = "dark gray"))


#######prosocial


customviz_nonaffil_vR50 <- ggplot(social_nonaffiliative_vR_50, aes(x=diet_group, y=social_nonaffiliative, color=diet_group)) +
  geom_boxplot() +
  geom_jitter() +
  theme_grey()
  #geom_smooth(method = "lm", se =FALSE)

customviz_affil_vR50+labs(title="Year 1: Social Non-Affiliative Behaviors (CTR=1, PR=2)", x="Diet",y="Non-Affiliative Behavior")  +
  scale_color_manual(values = wes_palette(n=2, "GrandBudapest1")) +
  theme(plot.background = element_rect(fill = "light gray"),
        panel.background = element_rect(fill = "dark gray"),
        legend.background = element_rect(fill = "dark gray"))



```


**Closing**


There are many things I need to improve on here but mainly:

-  **I want to finalize and better form my groupings** 
      - some of the composites were created using steal_resource_attempt rather than steal_resource_attempt_count.
And i am unsure of which would be the better approach for quantifying such behaviors. 
      
-  **I plan to run an SEM analysis to look at the fit of these composites** 
      - I wanted to get this to you prior to doing that so we can discuss changes/approaches to the SEMs.
      
      
-  **I am open to any changes. I am unsure if the makeup of the data allows us to use Community Detection, and I also thought grouping terms into pro-social/non-social/anxious provides a better output.** 
      - But again, we can adjust where needed.. this adjustment/documentation process has become increasingly faster for me. 
      
      