---
title: "methods_document"
author: "aj_mitchell"
date: "March 25, 2019"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyselect)
library(ggplot2)
library(broom)
library(dplyr)
library(corrplot)
library(kableExtra)
library(knitr)
library(Hmisc)
library(infer)
library(plotly) 
library(skimr)
library(stringr)
library(reshape2)
library(som)
library(readxl)
library(manipulate)
library(lavaan)
library(semPlot)
library(FactoMineR)
library(factoextra)
library(readxl)
library(formattable)
library(DT)
library(xtable)
```

The purpose of this document is to outline of the methods used to contruct composite variables from the raw behaviors collected form the Human Intruder Task. The data include the **Stare, Familiar Food Offer, and Novel Object** epochs and a total of 37 behaviors were included in the analysis. 

Below is a the first few rows of the normalized, raw data. Notice that the descriptive variables such as animal ID, interval time, etc have been removed in order to calculate correlations.

```{r loading the data, echo=FALSE}
znormed_ffostare_v1 <- read_excel("znormed_ffostare_v1.xlsx")
#skim(znormed_ffostare_v1)

selected_norms_ffostare_v1 <- znormed_ffostare_v1 %>%
  select(-Observations, - ResultContainers, - Intervals, - Zno_sec_behav_ffosta)
         
#head(selected_norms_ffostare_v1)         
```

Below is the correlation output for the data. 

```{r, echo=FALSE}
corrnorm_selected_ffostare_v1 <- cor(selected_norms_ffostare_v1)   
melted_corrnorm_selected_ffostare_v1 <- melt(corrnorm_selected_ffostare_v1)


ggplot(melted_corrnorm_selected_ffostare_v1, aes(x=Var2, y=Var1, fill=value)) +
  ggtitle("Combined Behavioral Correlations") +
  geom_tile() +
  scale_fill_gradient(low = "dark blue", high = "yellow") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   vjust = 1,
                                   size = 9,
                                   hjust = 1))


melted_corrnorm_selected_ffostare_v1_reduced <- melted_corrnorm_selected_ffostare_v1[order(melted_corrnorm_selected_ffostare_v1$value, decreasing = TRUE),] %>%
  filter(value <= .99)

#kable(melted_corrnorm_selected_ffostare_v1_reduced) %>%
  #kable_styling(bootstrap_options = c("hover", "condensed", "striped")) %>% 
  #scroll_box(width = "1000px", height = "400px")

as.datatable(formattable(melted_corrnorm_selected_ffostare_v1_reduced,
                         align = c("l", "l")))
```

From correlational values above were used to investigate the relationships amongst the behaviors. Specifically, how behaviors cluster together. To do this, an empirical approach was chosen that used community detection algorithm to determin which behaviors were clustering together. 

The output of the community detection is outline below. 4 communities were detected by this empirical process. These communities will now be considered **composite behaviors** (thus 4 composite behaviors emerged from this analysis) which we will investigate diet differences on. 

One thing I want to do is reduce the size of **Composite 1**, as it contains too many variables to accurately define a latent behavioral trait. PCA and SEM modeling was used to investigated the strength of these composite groupings; those figures are at the end of this document.   

```{r creating the composite scores, echo=FALSE}
selected_norms_ffostare_v1$comp_1 <- selected_norms_ffostare_v1$Zstationary_middle_percent_butters + selected_norms_ffostare_v1$Zlocomotion_percent_butters + selected_norms_ffostare_v1$Zhanging_behaviors_butters + selected_norms_ffostare_v1$Ztactile_exploration_butters + selected_norms_ffostare_v1$Zmo_manip_apple_butters + selected_norms_ffostare_v1$Zstation_fr_ffostare + selected_norms_ffostare_v1$Zstation_mid_ffosta + selected_norms_ffostare_v1$Zlocomote_ffosta + selected_norms_ffostare_v1$Zmovement_ffosta + selected_norms_ffostare_v1$Ztac_expl_ffosta + selected_norms_ffostare_v1$Zstereo_ffosta + selected_norms_ffostare_v1$Zteethgrind_ffosta + selected_norms_ffostare_v1$Zlipsmack_ffosta + selected_norms_ffostare_v1$Ztouch_app_ffosta + selected_norms_ffostare_v1$Zmouth_app_ffosta + selected_norms_ffostare_v1$Zmanip_app_ffosta + selected_norms_ffostare_v1$Zeat_app_ffosta + selected_norms_ffostare_v1$Znonvigi_ffosta + selected_norms_ffostare_v1$Zdir_eye_contact_ffosta
  
selected_norms_ffostare_v1$comp_2 <- selected_norms_ffostare_v1$ZStationary_back_butters + selected_norms_ffostare_v1$Zstereotypy_butters + selected_norms_ffostare_v1$Zvigilant_percent_butters + selected_norms_ffostare_v1$Zstation_back_ffostare + selected_norms_ffostare_v1$Zself_gro_ffosta + selected_norms_ffostare_v1$Zthreat_stranger_ffosta + selected_norms_ffostare_v1$Zfreeze_back_ffosta 
  
selected_norms_ffostare_v1$comp_3 <- selected_norms_ffostare_v1$Zstationary_front_percent_butters + selected_norms_ffostare_v1$Zmovement_percent_butters + selected_norms_ffostare_v1$Ztouch_butters_percent + selected_norms_ffostare_v1$Zcrouching_butters + selected_norms_ffostare_v1$Znonvigilant_percent_butters + selected_norms_ffostare_v1$Zcrouching_ffosta + selected_norms_ffostare_v1$Zvigi_ffosta + selected_norms_ffostare_v1$Zno_response_ffosta
  
selected_norms_ffostare_v1$comp_4 <- selected_norms_ffostare_v1$Zself_groom_percent_butters + selected_norms_ffostare_v1$Zmouth_butters_percent + selected_norms_ffostare_v1$Zoral_exploration_butters 
```


```{r no response groups}
selected_norms_ffostare_v1$comp_2.2 <- selected_norms_ffostare_v1$Zstereotypy_butters + selected_norms_ffostare_v1$Zstation_back_ffostare + selected_norms_ffostare_v1$Zself_gro_ffosta + selected_norms_ffostare_v1$Zthreat_stranger_ffosta + selected_norms_ffostare_v1$Zfreeze_back_ffosta


selected_norms_ffostare_v1$comp_3.2 <- selected_norms_ffostare_v1$Zstationary_front_percent_butters + selected_norms_ffostare_v1$Zmovement_percent_butters + selected_norms_ffostare_v1$Ztouch_butters_percent + selected_norms_ffostare_v1$Zcrouching_butters + selected_norms_ffostare_v1$Znonvigilant_percent_butters + selected_norms_ffostare_v1$Zcrouching_ffosta + selected_norms_ffostare_v1$Zvigi_ffosta + selected_norms_ffostare_v1$Zno_response_ffosta + selected_norms_ffostare_v1$ZStationary_back_butters + selected_norms_ffostare_v1$Zvigilant_percent_butters

skim(selected_norms_ffostare_v1)

write.csv(selected_norms_ffostare_v1, "selected_norms_composites_demgraf_v1.csv")
```
The output below represents the composite scores for the individual animals. 

Composite scores were created by taking the value of each individual behavior from the output of community detection. Below represent the individual scores for each animal and their respective categorical groupings.

```{r inserting demographic infomation, echo=FALSE}
selected_norms_composites_demgraf_v1.2 <- read.csv("selected_norms_composites_demgraf_v1.csv")
View(selected_norms_composites_demgraf_v1.2)

composite_scores_withgroups <- selected_norms_composites_demgraf_v1.2[order(selected_norms_composites_demgraf_v1$initial_diet),]  %>%
  select(Observations, sex, initial_diet, new_diet, comp_1, comp_2, comp_3, comp_4) 

View(composite_scores_withgroups)

composite_scores_withgroups$initial_diet <- as.factor(composite_scores_withgroups$initial_diet)
composite_scores_withgroups$new_diet <- as.factor(composite_scores_withgroups$new_diet)
composite_scores_withgroups$sex <- as.factor(composite_scores_withgroups$sex)

#glimpse(composite_scores_withgroups)

kable(composite_scores_withgroups, "html") %>%
  kable_styling(bootstrap_options = c("hover", "condensed", "striped"),
                row_label_position = l,
                full_width = F,
                position = "center") %>%
  add_header_above(c(" " = 2, "Diet Groups" = 2, "Composite Scores" = 4))

  
  
```

```{r filtering out individuals with postnatal diet group 2, echo=FALSE}
matdiet_filtered <- composite_scores_withgroups %>%
  filter(!new_diet == 2)
```

Below are the Pvalues for each of the composite groups. These values were calculated using the Wilcoxon rank sum test after failing the normality test. Only Composite Variable 1 and Composite Variable 2 displayed a significant effect of diet group.

These data have had all *new_diet* animals removed in order to only look at the effects of maternal diet on temperament. 

```{r t test for effects of maternal diet, echo=FALSE, warning = FALSE, mesage = FALSE}
matdiet_filtered_wiltest_comp1 <- wilcox.test(matdiet_filtered$comp_1~matdiet_filtered$initial_diet)
matdiet_filtered_wiltest_comp2 <- wilcox.test(matdiet_filtered$comp_2~matdiet_filtered$initial_diet)
matdiet_filtered_wiltest_comp3 <- wilcox.test(matdiet_filtered$comp_3~matdiet_filtered$initial_diet)
matdiet_filtered_wiltest_comp4 <- wilcox.test(matdiet_filtered$comp_4~matdiet_filtered$initial_diet)


matdiet_pvals <- c(matdiet_filtered_wiltest_comp1$p.value, matdiet_filtered_wiltest_comp2$p.value, matdiet_filtered_wiltest_comp3$p.value, matdiet_filtered_wiltest_comp4$p.value)
composite_frame_matdietpval <- c("Composite 1 P-value",
                                 "Composite 2 P-value",
                                 "Composite 3 P-value",
                                 "Composite 4 P-value")

matdiet_composite_difference <- data.frame(composite_frame_matdietpval, matdiet_pvals)

#kable(matdiet_composite_difference, format = "html", align=rep('l', 5)) %>%
  #kable_styling(bootstrap_options = c("condensed", "striped"))


bold_pvals <- formatter("span",
                        style = x ~ style("font-weight" = ifelse(x<.05, "bold", NA)))

#formattable(matdiet_composite_difference, list(
  #matdiet_pvals = bold_pvals
#))

as.datatable(formattable(matdiet_composite_difference,
                         align = c("l", "l"),
                         list(matdiet_pvals = bold_pvals)
                         ))

#xtab1 <- xtable(summary(matdiet_filtered_wiltest_comp2))
#View(xtab1)

#make a data table here!
```

```{r visulizations of significant composites for maternal diet, echo=FALSE, warning = FALSE}
ggcomp1 <- ggplot(matdiet_filtered, aes(x=Observations, y=comp_1, color=initial_diet, fill=initial_diet)) +
  geom_bar(stat = "identity", width = 20, position = position_dodge())

ggcomp2 <- ggplot(matdiet_filtered, aes(x=Observations, y=comp_2, color=initial_diet, fill=initial_diet)) +
  geom_bar(stat = "identity", width = 20, position = position_dodge())

dotplotly_comp2 <- ggplot(matdiet_filtered, aes(x=Observations, y=comp_2, color=initial_diet, fill=initial_diet)) +
  geom_point(stat = "identity") + 
  geom_smooth(method = "lm", se = FALSE)

ggcompl2_ly <- ggplotly(ggcomp2)
ggcompl2_ly

ggdotcomp2_ly <- ggplotly(dotplotly_comp2)
ggdotcomp2_ly

dotplotly_comp1 <- ggplot(matdiet_filtered, aes(x=Observations, y=comp_1, color=initial_diet, fill=initial_diet)) +
  geom_point(stat = "identity") + 
  geom_smooth(method = "lm", se = FALSE)

ggcompl1_ly <- ggplotly(ggcomp1)

ggcompl1_ly

ggdotcomp1_ly <- ggplotly(dotplotly_comp1)

ggdotcomp1_ly
```

```{r, echo=FALSE, warning=FALSE}
matdiet_sex_wiltest_comp1 <- wilcox.test(matdiet_filtered$comp_1~matdiet_filtered$sex)
matdiet_sex_wiltest_comp2 <- wilcox.test(matdiet_filtered$comp_2~matdiet_filtered$sex)
matdiet_sex_wiltest_comp3 <- wilcox.test(matdiet_filtered$comp_3~matdiet_filtered$sex)
matdiet_sex_wiltest_comp4 <- wilcox.test(matdiet_filtered$comp_4~matdiet_filtered$sex)


```



